# 共通鍵暗号（Symmetric Cryptography）

## 概要
同一の秘密鍵を用いて暗号化と復号を行う方式。一般に高速・低レイテンシで大容量データの機密性保護に適する。実運用では改ざん検知を同時に満たす認証付き暗号（AEAD）が標準（例: AES-GCM, ChaCha20-Poly1305）。

## アルゴリズムの概要（鍵生成・暗号化・復号化）
- 鍵生成 \( \mathrm{KeyGen}(1^{\lambda}) \rightarrow k \)
  - セキュリティパラメータ \(\lambda\) に対して、暗号学的安全な乱数で十分な長さ（一般に 128/256 bit）の鍵 \(k\) を生成。
- 暗号化 \( \mathrm{Enc}(m, k; \text{nonce}, \text{aad}) \rightarrow c \)
  - 平文 \(m\) を鍵 \(k\) と一意な \(\text{nonce}\)（IV）で暗号化し、暗号文 \(c\) を得る。AEAD では追加認証データ \(\text{aad}\) を併用できる。
  - 多くのモードで \(\text{nonce}\) の再利用は致命的（同鍵・同 \(\text{nonce}\) の再使用禁止）。
- 復号化 \( \mathrm{Dec}(c, k; \text{nonce}, \text{aad}) \rightarrow m \text{ または } \bot \)
  - 正しい鍵と対応するメタデータ（\(\text{nonce}\), \(\text{aad}\)）で復元。AEAD では検証失敗時は \(\bot\)（失敗）を返す。
- 決定的/確率的
  - 決定的暗号は同じ入力で同じ出力となりやすく、パターンが漏れる。実運用は \(\text{nonce}\)/内部乱数を用いた確率的暗号が前提。

## 性質
- 正当性（Correctness）
  - 任意の \(m, \text{nonce}, \text{aad}\) について \( \mathrm{Dec}(\mathrm{Enc}(m, k; \text{nonce}, \text{aad}), k) = m \) が成り立つ（改ざん時は \(\bot\)）。
- 秘匿性（Confidentiality）
  - 現代的定義は識別不能性（IND）。少なくとも IND-CPA（選択平文攻撃下の識別不能）が必要。
  - 実用では AEAD を用いて IND-CCA（選択暗号文攻撃下）相当を狙うのが一般的。

## 安全性モデルと攻撃の種類
- 暗号文単独攻撃（COA）
  - 暗号文のみを入手して推測（頻度解析など）。
- 既知平文攻撃（KPA）
  - 一部の平文と対応する暗号文を既知とした上で推測。
- 選択平文攻撃（CPA）
  - 任意に選んだ平文を暗号化させ、その結果を観測できる状態での攻撃。現代の最低想定モデル。
- 選択暗号文攻撃（CCA1）
  - チャレンジ前に復号オラクルへ暗号文を問い合わせ可能な状態での攻撃。
- 適応的選択暗号文攻撃（CCA2）
  - チャレンジ前後で復号オラクルへ適応的に問い合わせ可能な状態での攻撃（ただし、チャレンジ暗号文そのものは不可）。
- 強さの序列
  - \( \mathrm{CCA2} > \mathrm{CCA1} > \mathrm{CPA} > \mathrm{KPA} > \mathrm{COA} \)。AEAD は実質 CCA2 を想定して設計される。

## 共通鍵暗号の分類
- ストリーム暗号
  - 鍵と \(\text{nonce}\) から疑似乱数列（キーストリーム）を生成し、平文と XOR。例: ChaCha20（推奨）、Salsa20、RC4（非推奨）。
  - 高速・任意長に適合。\(\text{nonce}\) 再利用は致命的（キーストリーム露呈）。改ざん耐性は別途 MAC/AEAD が必要。
  - 歴史: ヴァーナム暗号（ワンタイムパッド; 完全秘匿だが実運用困難）。詳細は [ヴァーナム暗号（OTP）](./vernam.md) と [ストリーム暗号まとめ](./stream_ciphers.md) を参照。
- ブロック暗号
  - 固定長ブロックに対する擬似乱数置換（PRP）。代表は AES（128-bit ブロック、鍵長 128/192/256-bit）。
  - モード例: ECB（非推奨: パターン漏洩）、CBC/CFB/OFB/CTR、XTS（ストレージ向け）、GCM（AEAD・推奨）。
  - CTR/GCM 等は \(\text{nonce}\) 一意性が必須。モード選択と運用が安全性を大きく左右。
  - 詳細は [ブロック暗号](./block_ciphers.md) を参照。
  - 歴史的方式（非推奨）: [DES](./des.md)

## 実務の要点（ベストプラクティス）
- 認証付き暗号（AEAD: AES-GCM または ChaCha20-Poly1305）を使用。
- \(\text{nonce}/\text{IV}\) の一意性を厳守（鍵ごとに再利用禁止。GCM では 12 バイトが標準）。
- 鍵は十分な長さを暗号学的乱数で生成・安全に保存（鍵管理/KMS の利用を推奨）。
- 平文の機密性と完全性（改ざん検知）を同時に満たす設計にする（暗号＋MAC か AEAD）。
- 決定的暗号化の安易な採用を避ける。メタデータ（\(\text{aad}\)）でヘッダ等の完全性も保護。

## 代表的なアルゴリズム
- AES-GCM（推奨 AEAD。ハードウェア最適化が豊富）
- ChaCha20-Poly1305（ソフトウェアで高速、モバイルや組込みで有利）
- RC4 は歴史的に広く使われたが、現代では安全でないため非推奨
- DES（歴史的・非推奨）: 詳細は [DES](./des.md)

## サンプルコード
- AES-GCM 実装例: `src/symmetric/aes_gcm.ts`

## セキュリティ上の注意
- 鍵長は 128/256 bit が一般的（256 bit は安全余裕）。
- GCM の `IV/nonce` は原則 12 バイト・重複禁止（再利用は壊滅的）。
- 乱数・鍵・nonce 生成は必ず暗号学的安全な PRNG を使用。
- 誤用を検知しやすいログとエラーハンドリング（ただし復号失敗の詳細は攻撃面に配慮）。

## 参考資料
- NIST SP 800-38D: Galois/Counter Mode (GCM)
- IETF RFC 8439: ChaCha20-Poly1305 