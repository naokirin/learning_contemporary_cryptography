# ブロック暗号（Block Ciphers）

## 概要
- **定義**: 固定長ブロック（典型的には 128-bit）に対して、鍵付きの置換を実現する擬似乱数置換（PRP: Pseudorandom Permutation）。暗号化器 \( E_k: \{0,1\}^n \to \{0,1\}^n \) と復号器 \( D_k = E_k^{-1} \) を持ち、\( D_k(E_k(m)) = m \)。
- **代表例**: AES（ブロック長 128-bit、鍵長 128/192/256-bit）。DES/3DES は歴史的で現代では非推奨。
- **位置づけ**: 単体では固定長しか扱えないため、可変長メッセージにはブロック暗号モード（CBC/CTR/GCM/XTS など）を用いる。実務では認証付き暗号（AEAD）の AES-GCM が標準。

## 用語と前提知識
- **ブロック長（block size）**: 入出力の固定長（AES は 128-bit）。
- **鍵長（key size）**: 鍵のビット長（AES は 128/192/256-bit）。
- **PRP/SPR**: PRP は鍵付き置換。強擬似乱数置換（SPR）は選択平文・選択暗号文クエリ下でもランダム置換と見分け困難。
- **パディング（padding）**: 固定長に満たない最後のブロックを埋める手順（例: PKCS#7）。モードにより必要・不要が異なる（CBC は必要、CTR/GCM は不要）。
- **IV/ノンス**: モードが要求する一意化値。ランダム性や一意性など、モードごとに要件が異なる。
- **ツイーク（tweak）/tweakable block cipher**: 追加パラメータ（セクタ番号等）で置換を切り替える概念。XEX/XTS などで用いる。

## 安全性の観点
- **目標**: PRP/SPR としての見分け困難性。実運用では「モード＋運用要件」を満たして初めて IND-CPA/CCA 相当を達成する。
- **誤用時の脅威**:
  - ECB のパターン漏洩（非推奨）。
  - CBC+PKCS#7 の padding oracle（エラーメッセージやタイミング差で平文回収）。
  - CTR/GCM のノンス再利用（壊滅的）。
  - XTS は認証を提供しない（ストレージ用途限定、完全性は別途）。

### パラメータ（鍵長・ブロック長）の安全性

- **鍵長（Secret key length）**
  - 計算量的安全性: 総当たりに必要な試行回数は概ね \(2^k\)。安全強度は \(k\) ビット。
  - 推奨: 最低 128-bit。長期保護や規制準拠では 192/256-bit を選択。
  - 量子考慮: Grover により探索量は概ね \(2^{k/2}\) に低下。長期・PQ を考慮するなら AES-256（≈128-bit 相当）。
  - 性能: AES-256 はラウンド数増で AES-128 より遅い（環境依存）。

- **ブロック長（Block size）**
  - 誕生日境界: \(n\)-bit ブロックでは同一鍵で約 \(2^{n/2}\) ブロック処理すると衝突確率が顕在化。
  - 64-bit ブロック（DES/3DES 等）: 約 \(2^{32}\) ブロック（8B×\(2^{32}\) ≈ 32 GiB）で安全域を逸脱しやすい。新規採用は避ける。
  - 128-bit ブロック（AES）: 誕生日境界は約 \(2^{64}\) ブロック（16B×\(2^{64}\) ≈ 295 EB）。実務ではモード側の制約が支配的。
  - GCM 例: ノンス一意性は必須。1 鍵あたりの呼び出し回数/処理データ量にはガイド上限がある（例: 2^32 近傍の呼び出し上限、タグ偽造確率の管理）。

- **実務の指針**
  - 一般用途: AES-128 を標準、将来・コンプライアンス要件で AES-256。
  - ブロック長は 128-bit を採用。64-bit ブロック暗号の新規採用は避ける。
  - モード要件（ノンス一意性・データ量上限）を運用設計に反映。

## 攻撃手法

### 全面的攻撃（Generic / ブラックボックス）
- **定義**: 暗号の内部構造を利用せず、理想的な擬似乱数置換（PRP）として扱う攻撃の総称。理論上の下限は鍵長・ブロック長に依存。
- **代表**: ブルートフォース（鍵全数探索）、テーブル参照法（コードブック攻撃）、タイムメモリトレードオフ（TMTO）。
- **安全ライン**: 構造依存の「ショートカット攻撃」が存在しない限り、最善は鍵全数探索に近い計算量。

#### ブルートフォース攻撃
- **鍵全数探索攻撃**
  - 鍵空間が \(2^k\) のとき、期待計算量は約 \(2^{k-1}\)（平均）。
  - 検証は 1～数組の既知平文-暗号文ペアで実施（Wrong-Key Randomization 仮定）。
  - 並列化が容易。量子下では Grover により概ね \(2^{k/2}\) へ低下。
- **テーブル参照法（コードブック攻撃）**
  - ブロック長 \(n\) に対して全平文 \(2^n\) と対応暗号文を事前計算・保存し、復号/照合をテーブル参照で実施。
  - 時間・メモリとも \(2^n\) 規模が必要。64-bit でも非現実的、128-bit では実質不可能。
  - 強力な選択平文オラクルがある場合にのみ現実化余地（それでも資源的に困難）。
- **タイムメモリトレードオフ（TMTO; Hellman/Rainbow）**
  - 事前計算（Precomputation）とメモリ（M）を投じて、オンライン時間（T）を短縮する枠組み。
  - 目安として \(T\cdot M \approx 2^k\)（成功確率・定数で補正）。レインボーテーブルは連鎖衝突を低減。
  - 大きな事前計算コストと保存要件が現実的制約。鍵やノンスの頻繁な更新で実効性は下がる。

#### ショートカット攻撃（構造依存の暗号解読）
- **定義**: 内部構造（S-box/拡散/鍵スケジュール等）の偏りを利用し、鍵全数探索より少ない計算量で鍵回収・区別・復号を狙う。
- **代表例**: 差分解読、線形解読、統合（Integral）/不可能差分、右回り/左回り（Boomerang）、中間一致（Meet-in-the-middle; 多重暗号）など。
- **評価軸**: 計算量（T）、データ量（D; 必要平文/暗号文ペア数）、メモリ量（M）。安全設計は十分なラウンド数とワイドトレイル等で余裕を確保。

### 識別攻撃と識別不可能性
- **識別攻撃の概要**: 攻撃者はオラクルが「実際のブロック暗号 \(E_k\)」か「一様ランダム置換（RP）」かを当てるゲームを行う。優位性（Adv）が有意に大きければ区別可能＝弱点。

### 識別不可能性の階層（完全・統計・計算量）
- **完全識別不可能性（情報理論的）**
  - 任意の攻撃者（計算量無制限）・任意のクエリ戦略に対して識別優位性が 0。分布が同一であることを意味（Adv = 0）。
  - 例: 真の乱数を用いる理想的構成（OTP など）は達成可能だが、現実的な固定鍵ブロック暗号族では一般に達成不可能。
- **統計的識別不可能性**
  - 任意の攻撃者（計算量無制限）に対して識別優位性が高々 ε。二つの分布の全変動距離が ε 以下であることに相当。
  - 厳密な確率的境界を与えるが、固定鍵の実用ブロック暗号族で強い ε を満たすのは困難。
- **計算量的識別不可能性**
  - 任意の効率的攻撃者（多項式時間 t・クエリ数 q）に対して、識別優位性が無視可能 negl(λ) か、所定上限 ε(t, q) 以下。
  - ブロック暗号の PRP/SPR 安全性は通常この意味で定義され、セキュリティパラメータ λ は鍵長 k に由来。
- **関係**: 完全 ⇒ 統計 ⇒ 計算量。実用ブロック暗号の目標は計算量的 PRP/SPR（効率的攻撃者に対する区別不能）。

### 安全性評価（最良既知攻撃とセキュリティマージン）
- **公開鍵暗号・デジタル署名との相違**
  - 多くの公開鍵方式は計算困難性仮定に基づく還元的安全性（IND-CPA/IND-CCA、EUF-CMA 等）を示せる。一方、ブロック暗号は「鍵付き置換が擬似乱数的（PRP/SPR）である」ことを一般には証明できず、実務では「現在知られているショートカット攻撃への耐性」で安全性を評価する。
- **評価の基本軸（T/D/M と脅威モデル）**
  - 最良既知攻撃の計算量 T・データ量 D・メモリ量 M が、鍵全数探索や運用上の限界を十分に上回るかを確認。
  - 選択平文/選択暗号文、関連鍵攻撃など複数モデルでの最良既知攻撃も併せて確認。
- **セキュリティマージン**
  - 定義: 総ラウンド数 R と、攻撃が到達する最大ラウンド r_break の差 \(R - r_{break}\)。差分・線形・不可能差分・Integral・Boomerang・Differential-Linear・代数的・MITM 等の各攻撃族ごとに評価し、十分な余裕を確保。
  - D\(_{break}\)（必要データ量）、成功確率、要求前提（選択平文可否・関連鍵前提の有無）も併せて評価。
  - 設計観点: ワイドトレイル戦略、S-box の非線形性/差分一様性、拡散層の分岐数、鍵スケジュールの強度でマージンを確保。
- **留意**
  - マージンは証明ではなく、将来の暗号解読で縮む可能性がある。標準化・広範な第三者評価のある方式を採用し、知見更新時は見直す。

### 規模感の目安と AES/DES の例
- **識別優位性（Birthday / PRP⇔RP）**
  - クエリ数 \(q\) に対し、理想置換との差の識別優位性は概ね \(\mathrm{Adv} \lesssim q(q-1)/2^{n+1}\)。\(q \approx 2^{n/2}\) で有意に。
- **DES（k=56, n=64）**
  - ブルートフォース: 期待 \(\approx 2^{55}\) 試行。
  - 差分解読（Biham-Shamir）: 典型的に \(\approx 2^{47}\) 組の選択平文ペア。
  - 線形解読（Matsui）: \(\approx 2^{43}\) 個の既知平文。
  - コードブック（テーブル参照）: \(2^{64}\) エントリ（時間/メモリとも現実的でない）。
- **AES-128（k=128, n=128）**
  - ブルートフォース: 期待 \(\approx 2^{127}\) 試行（Grover 下でも \(\approx 2^{64}\) クエリ）。
  - 既知のショートカット: 実用的なものは未知ら。攻撃は減ラウンド版に限定・膨大なデータ/計算量を要する。
  - 識別（Birthday）: \(q \approx 2^{64}\) ブロックで有意になり得るが、鍵回収を意味しない。運用上はモード/ノンス要件が支配的。

> 注意: 上記は代表値の目安であり、攻撃モデル（既知/選択平文、鍵スケジュール仕様、ラウンド数等）に依存して変動する。

## 内部構造（Feistel 構造と SPN 構造）

### Feistel 構造
- **基本形**: ブロックを左右半分に分割し、ラウンド \(i\) で
  - \( L_{i+1} = R_i \)
  - \( R_{i+1} = L_i \oplus F_{K_i}(R_i) \)
  - ここで \(F\) はラウンド関数、\(K_i\) はサブ鍵。\(F\) 自体は非可逆でもよいが、ネットワーク全体は可逆。
- **復号**: サブ鍵順序を逆にして同じ構造を適用すればよい（同じ \(F\) を使用できる）。
- **派生**: バランス/アンバランス、一般化 Feistel（GFS）、2n 分割など。
- **代表例**: DES、Blowfish、Twofish、Camellia（Feistel 系構成）。

#### 暗号化アルゴリズム例（擬似コード）

```text
function Feistel_Encrypt(M, K[1..r]):            // 入力: 平文ブロック M、サブ鍵列 K[1..r]
  (L, R) <- split_into_halves(M)                  // 初期分割: 左右半分に分ける
  for i from 1 to r:                              // r ラウンド繰り返す
    // Feistel 更新: 右を左へスワップし、左は F(K[i], 旧右) と XOR
    (L, R) <- (R, L XOR F(K[i], R))
  return concatenate(L, R)                        // 連結して暗号文ブロックを得る（この定義では最終スワップ済み）
```

### SPN 構造（Substitution-Permutation Network）
- **基本形**: ラウンドごとに（順序は方式により異なるが概ね）
  - AddRoundKey（\( x \leftarrow x \oplus K_i \)）
  - 非線形代入（S-box を並列適用: \( x \leftarrow S(x) \)）
  - 線形拡散層（ビット置換や行列乗算: \( x \leftarrow P(x) \)）
- **復号**: 各層の逆変換（逆 S-box、逆拡散）を用いる。S-box と線形層は可逆である必要。
- **代表例**: AES（SubBytes/ShiftRows/MixColumns/AddRoundKey）、PRESENT、Serpent。

#### 暗号化アルゴリズム例（擬似コード）

```text
function SPN_Encrypt(M, K[0..r]): // 入力: 平文ブロック M、ラウンド鍵 K[0..r]
  x <- M                          // 初期状態
  x <- x XOR K[0]                 // 初回 AddRoundKey（前置ホワイトニング）
  for i from 1 to r-1:            // 中間 r-1 ラウンド
    x <- S(x)                     // 非線形置換（S-box）
    x <- P(x)                     // 線形拡散（置換/行列）
    x <- x XOR K[i]               // AddRoundKey
  x <- S(x)                       // 最終ラウンドは拡散なしの S のみ（方式による）
  x <- x XOR K[r]                 // 最終 AddRoundKey（ポストホワイトニング）
  return x                        // 暗号文ブロック
```

### 比較と留意点
- **復号手順**: Feistel は同じラウンド関数でサブ鍵を逆順に適用。SPN は各層の逆変換を要する。
- **実装/性能**: SPN は並列化・SIMD 最適化に適しやすい。Feistel はハーフブロックでの入出力でメモリ局所性が良いことも。
- **設計要件**: Feistel は \(F\) の可逆性不要。SPN は S-box/拡散層の可逆性が必要。いずれも差分/線形攻撃への強さ（S-box の非線形性、拡散の分岐数、ワイドトレイル設計）と十分なラウンド数が鍵。
- **典型ラウンド数**: DES は 16、AES は 10/12/14（鍵長に依存）。

## 一般形（モデル）
- 暗号化 \( c = E_k(m) \), 復号 \( m = D_k(c) \), ただし \( E_k \) は各鍵ごとに全単射で \( D_k = E_k^{-1} \)。
- そのままではメッセージ長が \(n\) の倍数に限定されるため、モードで可変長に拡張する。

## 暗号化モード（Mode of Operation）とは
- **定義**: ブロック暗号 \(E_k\) を可変長メッセージに拡張し、IV/ノンス、ランダム化、並列化、エラー伝播、認証の有無などの運用ルールを規定する構成。
- **目的**: 可変長データの暗号化、ストリーミング/ランダムアクセス対応、期待する安全性（IND-CPA/IND-CCA、AEAD）を実現。
- **主な構成要素**:
  - 初期化ベクトル/ノンス: 一意性やランダム性の要件はモードごとに異なる（例: GCM は 96-bit ノンス一意性が標準）。
  - パディング: CBC は PKCS#7 等のパディングが必要。CTR/GCM/OCB/CCM は不要。
  - 認証の有無: 機密性のみ（CBC/CTR 等）か、機密性＋完全性（AEAD: GCM/CCM/OCB/SIV 等）。
  - 並列化/ランダムアクセス: CTR/GCM/OCB は並列化・ランダムアクセスに適合。CBC は暗号化が直列的。
  - エラー伝播特性: CBC は 1 ブロック＋次ブロックに誤りが伝播、CTR/GCM は該当ブロックに限定（認証失敗で全体破棄）。
- **誤用と注意**:
  - ノンス再利用の禁止（特に CTR/GCM/OCB）。同一鍵・同ノンスは壊滅的。
  - データ量・呼び出し回数上限の遵守（例: GCM の per-key/per-nonce 上限）。
  - AEAD ではタグ検証成功まで平文を公開しない。検証は一定時間で行う。
- **分類**:
  - 機密性のみ: ECB（非推奨）、CBC、CFB、OFB、CTR、XTS（ストレージ向け・認証なし）。
  - AEAD: GCM、CCM、EAX、OCB、SIV（誤用耐性・決定的）。

### モード比較表（要点）

| モード | AEAD | ノンス/IV要件            | パディング      | 並列化                    | ランダムアクセス | 誤り伝播           | 主用途/備考                             |
| ------ | ---- | ------------------------ | --------------- | ------------------------- | ---------------- | ------------------ | --------------------------------------- |
| ECB    | ×    | 不要                     | 要              | 高                        | 可               | 当該ブロックのみ   | 非推奨（パターン漏洩）                  |
| CBC    | ×    | ランダムIV必須           | 要（PKCS#7 等） | 低（暗号化直列/復号並列） | 不可             | 2ブロックへ伝播    | レガシー互換                            |
| CFB    | ×    | IV必須                   | 不要            | 低                        | 不可             | 連鎖的に伝播       | レガシー互換                            |
| OFB    | ×    | ノンス/IV一意            | 不要            | 中                        | 限定的           | ほぼ限定的         | レガシー互換                            |
| CTR    | ×    | ノンス一意               | 不要            | 高                        | 可               | 当該ブロックのみ   | ストリーム化基盤、Encrypt-then-MAC 併用 |
| XTS    | ×    | ツイーク（セクタ番号等） | 不要            | 高                        | 可               | セクタ内局所       | ディスク暗号（認証なし）                |
| GCM    | ○    | 96-bit ノンス一意        | 不要            | 高                        | 可               | 認証失敗で全体破棄 | 汎用 AEAD、TLS 等                       |
| CCM    | ○    | ノンス一意               | 不要            | 中（CTR高/CMAC直列）      | 限定的           | 認証失敗で全体破棄 | 組込み/無線（802.15.4 等）              |
| EAX    | ○    | ノンス一意               | 不要            | 中                        | 限定的           | 認証失敗で全体破棄 | 汎用 AEAD                               |
| OCB    | ○    | ノンス一意               | 不要            | 高                        | 可               | 認証失敗で全体破棄 | 高速 AEAD（歴史的に特許）               |
| SIV    | ○    | 原則ノンス不要（決定的） | 不要            | 低〜中                    | 可               | 認証失敗で全体破棄 | 誤用耐性（ノンス再利用に強い）          |

## ブロック暗号モード（主要方式）
- **ECB（Electronic Codebook）: 非推奨**
  - 各ブロックを独立に暗号化。パターンがそのまま残るため秘匿性を満たさない。
- **CBC（Cipher Block Chaining）**
  - ランダム IV を用い、\( c_i = E_k(m_i \oplus c_{i-1}) \)。パディングが必要。暗号化の並列化が難しい。
  - IND-CPA を満たすが、実装・エラーの扱いを誤ると padding oracle の危険。
- **CTR（Counter）**
  - カウンタブロックを \( E_k \) で暗号化し、その出力をキーストリームとして XOR。パディング不要。並列化容易。
  - ノンス（初期カウンタ）一意性が必須。Encrypt-then-MAC か AEAD で完全性を付与。
- **GCM（Galois/Counter Mode）: AEAD（推奨）**
  - CTR にガロア場上の認証（GHASH）を組み合わせる。並列化が容易で高速。
  - 12 バイトのノンスが推奨。ノンス再利用は禁止（タグ偽造確率が急増）。
- **XTS（XEX-based Tweaked CodeBook mode with ciphertext stealing）**
  - ディスク暗号向け。セクタ番号をツイークとして使用。可逆性とエラープロパゲーションがストレージに適合。
  - 機密性のみで完全性は提供しない。ストレージ用途以外には用いない。
- **CFB/OFB（歴史的）**
  - いずれもストリーム化して使うが、現代の新規採用では CTR/GCM が優先。
- **SIV（Synthetic IV, 例: AES-SIV）: 誤用耐性**
  - ノンス再利用に対する堅牢性（misuse-resistant）。決定的 AEAD。性能は GCM 等に劣るが、ノンス管理が困難な場面で有用。

## 実務のベストプラクティス
- **原則 AEAD を使う**: AES-GCM（または環境により ChaCha20-Poly1305）。
- **ノンス/IV の一意性**: 鍵ごとに重複禁止。GCM は 96-bit を標準とし、体系的な一意化（乱数＋カウンタ）を徹底。
- **鍵管理**: 128-bit 以上を暗号学的安全な PRNG で生成し安全保管。長期鍵からの派生は KDF（例: HKDF）で分離。
- **パディングとエラー処理**: CBC を用いる場合は PKCS#7。復号エラー時は情報を漏らさない均一な失敗応答。
- **代替構成**: AEAD 非対応環境では CTR + Encrypt-then-MAC（HMAC-SHA-256 等）を用いる。
- **ストレージ**: ファイル/ディスク暗号には XTS を用い、完全性は別途ファイルシステムや MAC で担保。

## サンプルコード
- AES-GCM 実装例: `src/symmetric/aes_gcm.ts`

## 関連ドキュメント
- 共通鍵暗号の概要と AEAD: `docs/003_symmetric/README.md`
- ストリーム暗号: `docs/003_symmetric/stream_ciphers.md`
- AES: `docs/003_symmetric/aes.md`
- DES: `docs/003_symmetric/des.md`
- トリプルDES（3DES/TDEA）: `docs/003_symmetric/triple_des.md`

## 参考資料
- FIPS 197: Advanced Encryption Standard (AES)
- NIST SP 800-38A: Recommendation for Block Cipher Modes of Operation
- NIST SP 800-38D: Galois/Counter Mode (GCM)
- NIST SP 800-38E: XTS-AES
- RFC 5297: Synthetic Initialization Vector (SIV) Authenticated Encryption
- Phillip Rogaway, “OCB: A Block-Cipher Mode of Operation for Efficient Authenticated Encryption”
- Martin E. Hellman, “A Cryptanalytic Time-Memory Trade-Off,” IEEE Transactions on Information Theory, 1980.
- Philippe Oechslin, “Making a Faster Cryptanalytic Time-Memory Trade-Off,” CRYPTO 2003.（Rainbow Tables）
- Eli Biham and Adi Shamir, “Differential Cryptanalysis of DES-like Cryptosystems,” Journal of Cryptology, 1991.
- Mitsuru Matsui, “Linear Cryptanalysis Method for DES Cipher,” EUROCRYPT 1993.
- Michael Luby and Charles Rackoff, “How to Construct Pseudorandom Permutations from Pseudorandom Functions,” SIAM J. Comput., 1988.
- Mihir Bellare and Phillip Rogaway, “The Security of Block Ciphers and the PRP/PRF Switching Lemma” 