# ストリーム暗号（Stream Ciphers）

## 概要
- **定義**: 鍵とノンス（nonce）から疑似乱数列（キーストリーム）を生成し、平文と XOR して暗号化する方式。復号も XOR。
- **特長**: 高速・低レイテンシ・任意長に適合。ストリーミングやパケット分割と相性が良い。
- **前提**: ノンスの再利用は致命的。同一鍵・同ノンスで同じキーストリームが再生成されるため、暗号文同士の XOR から平文同士の XOR が露呈する。
- **実務**: 単独では完全性を提供しないため、AEAD（例: ChaCha20-Poly1305）か Encrypt-then-MAC を用いる。

## 用語と前提知識
- **キーストリーム**: 疑似乱数生成器（PRG）が出力するビット/バイトの列。平文と XOR して暗号文を得る。
- **ノンス（nonce）**: 鍵と組み合わせてキーストリームを一意化する値。同一鍵でのノンス再利用は禁止。
- **カウンタ**: キーストリームをブロック単位で生成する際の位置指標（例: 32-bit/64-bit カウンタ）。
- **同期型 vs 自己同期型**:
  - 同期型（Synchronous）: キーストリームは内部状態のみで進む（例: ChaCha20, AES-CTR）。ビット欠落で同期がずれると復旧不能だが設計が単純で高速。
  - 自己同期型（Self-synchronizing）: 直近の暗号文をフィードバックして同期を回復（例: CFB のようなブロック暗号モード）。現代では新規採用は稀。
- **AEAD**: 機密性と完全性を同時に満たす方式。ストリーム暗号では ChaCha20-Poly1305 が広く用いられる。

## 一般形（モデル）
- 鍵生成 \( \mathrm{KeyGen}(1^{\lambda}) \to k \)
- キーストリーム生成 \( \mathrm{KSGen}(k, \text{nonce}, \text{counter}) \to s \)
- 暗号化 \( \mathrm{Enc}(m, k; \text{nonce}) = m \oplus s \)
- 復号化 \( \mathrm{Dec}(c, k; \text{nonce}) = c \oplus s \)
- 注意: 同鍵・同ノンスで同じ \(s\) が再生成される。よって \(c_1 \oplus c_2 = m_1 \oplus m_2\)（Two-Time Pad 問題）。

## ヴァーナム暗号（OTP）との違い
- **乱数源と定義**
  - OTP: 平文と同長の真の乱数鍵を一度だけ使用。暗号文は情報理論的に完全秘匿。
  - ストリーム暗号: 短い鍵とノンスから PRG で擬似乱数（キーストリーム）を生成。計算量的安全が前提。
- **鍵長・鍵管理**
  - OTP: \(\lvert k \rvert = \lvert m \rvert\)。鍵配送・保管・破棄が重く、同一鍵の再利用は不可。
  - ストリーム暗号: 固定長鍵 + ノンス。鍵は再利用可だが、ノンスはメッセージごとに一意であることが必須。
- **誤用時の壊れ方**
  - OTP: 鍵再利用（Two-Time Pad）で \(c_1\oplus c_2 = m_1\oplus m_2\) が露呈。
  - ストリーム暗号: 同鍵・同ノンス再利用で同様の露呈。ノンス一意性が生命線。
- **安全性の性質**
  - OTP: 情報理論的安全（計算能力に依存しない）。
  - ストリーム暗号: PRG/ブロック暗号の仮定に依存した計算量的安全（IND-CPA、AEAD で IND-CCA 相当）。
- **完全性（改ざん検知）**
  - どちらも素のままでは提供しない。Encrypt-then-MAC か AEAD を用いる。暗号鍵と MAC 鍵は KDF で分離。
- **適用領域**
  - OTP: オフライン・短文・特別高機密など、事前に安全な鍵配布が可能な場合に限定的。
  - ストリーム暗号: 一般的な通信・ストレージで広く実用（例: ChaCha20-Poly1305, AES-CTR/GCM）。

## 代表的方式と特性
- **ChaCha20（同期型・推奨）**
  - 256-bit 鍵、96-bit ノンス、32-bit ブロックカウンタ。20 ラウンドの加算・XOR・ローテート（ARX）構成。
  - ソフトウェア実装で高速・一定時間実装が比較的容易。モバイルや汎用 CPU で有利。
  - 実運用は AEAD の ChaCha20-Poly1305（IETF RFC 8439）を使用。
  - 一つのノンスあたり生成可能なキーストリームは理論上 2^32 ブロック（各 64 バイト）で約 256 GiB 程度まで。実装の上限に従うこと。
- **AES-CTR（ブロック暗号を用いたストリーム化）**
  - 128-bit ブロックのカウンタを AES で暗号化し、その出力をキーストリームとして使用。
  - 既定では完全性なし。Encrypt-then-MAC か AEAD（AES-GCM 等）を推奨。
  - ノンス（初期カウンタ）一意性とカウンタのオーバーフロー回避が必須。
- **OFB/CFB（歴史的）**
  - OFB: 出力フィードバックによりキーストリームを生成。ビット誤りの伝播特性は限定的だが、現代では推奨度は低い。
  - CFB: 自己同期型。エラー回復はするが、設計・実装上の複雑性と性能面から新規採用は稀。
- **RC4（非推奨）**
  - 初期バイトのバイアス、KSA の弱さ、WEP/TKIP などでの深刻な実害により現代では使用禁止レベル。

## セキュリティ上の注意
- **ノンス再利用禁止**: 同鍵・同ノンスはキーストリーム再利用＝壊滅的。
- **完全性の欠如**: 純粋なストリーム暗号は可鍛性が高い（暗号文のビット反転が平文に反映）。AEAD か Encrypt-then-MAC を必須とする。
- **カウンタ管理**: ブロック境界・ロールオーバー・並列化時の衝突防止を厳密に設計。
- **実装の一定時間性**: キーやノンス取り扱い、タグ検証など分岐のタイミングに注意。
- **鍵とノンスの分離**: 暗号と MAC の鍵は分離（KDF で派生）。ノンスはメッセージごとに一意化（乱数またはシーケンス）。

## 実務のベストプラクティス
- **原則 AEAD を使う**: ChaCha20-Poly1305 または AES-GCM。
- **どうしても純粋なストリーム暗号を使う場合**:
  - 構成は Encrypt-then-MAC（例: HMAC-SHA-256）。`aad || nonce || ciphertext` に対して MAC を計算し、検証成功後のみ復号。
  - 鍵派生: `master_key` から `enc_key` と `mac_key` を KDF（例: HKDF）で分離。
  - ノンス: 一意性を満たす 96-bit 程度（方式に依存）。乱数またはメッセージカウンタで衝突回避。
  - 再鍵装置（rekey）: 長大ストリームでは所定バイト数・時間で鍵/ノンスをローテーション。
- **運用チェック**
  - ノンスの重複監視、ログでのバージョニング、タグ検証失敗時の安全な失敗処理（詳細を漏らさない）。

## 関連ドキュメント
- ヴァーナム暗号（OTP）: `docs/003_symmetric/vernam.md`
- 共通鍵暗号の概要と AEAD: `docs/003_symmetric/README.md`

## 参考資料
- IETF RFC 8439: ChaCha20 and Poly1305 for IETF Protocols
- NIST SP 800-38A: Recommendation for Block Cipher Modes of Operation (CTR/CFB/OFB)
- NIST SP 800-38D: Galois/Counter Mode (GCM)
- eSTREAM Portfolio（CAESAR/eSTREAM の歴史的成果） 