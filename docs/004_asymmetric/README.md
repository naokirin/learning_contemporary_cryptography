## 公開鍵暗号（Public-Key / Asymmetric Cryptography）

### 概要
公開鍵で暗号化し、対応する秘密鍵で復号する方式。鍵配送問題を解決し、ハイブリッド暗号（KEM-DEM）や電子署名と組み合わせて実運用される。

- ハイブリッド暗号（推奨）: 公開鍵暗号でセッション鍵を安全に共有（KEM/Key Encapsulation）し、その鍵で共通鍵暗号（AEAD）により大量データを暗号化（DEM/Data Encapsulation）。
- 典型的用途: 機密性保護（暗号化）、鍵合意（KEM/ECDH）、真正性・否認防止（電子署名）。

### アルゴリズムの概要（鍵生成・暗号化・復号化）
- 鍵生成 \( \mathrm{KeyGen}(1^{\lambda}) \rightarrow (\mathrm{pk}, \mathrm{sk}) \)
  - セキュリティパラメータ \(\lambda\) に対して、公開鍵 \(\mathrm{pk}\) と秘密鍵 \(\mathrm{sk}\) を生成。
- 暗号化 \( \mathrm{Enc}(\mathrm{pk}, m; r) \rightarrow c \)
  - 平文 \(m\) を公開鍵 \(\mathrm{pk}\) で暗号化し暗号文 \(c\) を得る。セマンティックセキュリティのため暗号化は確率的（乱数 \(r\) を使用）が基本。
- 復号化 \( \mathrm{Dec}(\mathrm{sk}, c) \rightarrow m \text{ または } \bot \)
  - 秘密鍵 \(\mathrm{sk}\) で復号し、正しければ \(m\) を、失敗時は \(\bot\) を返す。

- KEM 形式（鍵カプセル化）の書き換え
  - カプセル化 \( \mathrm{Encap}(\mathrm{pk}) \rightarrow (K, c) \): 共有鍵 \(K\) とカプセル \(c\) を生成。
  - 復号化 \( \mathrm{Decap}(\mathrm{sk}, c) \rightarrow K \text{ または } \bot \)。得られた \(K\) を AEAD に渡す（DEM）。

### 性質
- 正当性（Correctness）
  - 任意の \(m\) について \( \mathrm{Dec}(\mathrm{sk}, \mathrm{Enc}(\mathrm{pk}, m)) = m \) が成り立つ（改ざんや不正入力時は \(\bot\)）。
- 秘匿性（Confidentiality）
  - 現代的な定義は「識別不能性（IND）」に基づく。最低限 IND-CPA が必要で、実務では IND-CCA2 が望ましい。
- 非改ざん性（Non-malleability）
  - 暗号文から意味のある関連する別暗号文を作れない性質。PKE では NM-CCA2 と IND-CCA2 は概ね同等強度とみなせる。

### 安全性モデルと攻撃の種類（攻撃者の能力）
- 選択平文攻撃（CPA）
  - 攻撃者は任意の平文を暗号化オラクルに問い合わせられる。
- 選択暗号文攻撃（CCA1）
  - チャレンジ前に限って復号オラクルに暗号文を問い合わせられる。
- 適応的選択暗号文攻撃（CCA2）
  - チャレンジ前後で適応的に復号オラクルへ問い合わせ可能（ただしチャレンジ暗号文そのものは不可）。
- 強さの序列
  - \( \mathrm{CCA2} > \mathrm{CCA1} > \mathrm{CPA} \)。実務では CCA2 を想定する設計（例: RSA-OAEP, KEM+AEAD）。

### 解読モデル（攻撃目標の定義）
- 全面的解読（Total break）
  - 秘密鍵の回復に成功し、以後すべての通信を解読可能。
- 完全解読（Complete break）
  - 秘密鍵は得られないが、任意の暗号文を復号できる（等価な復号アルゴリズムの獲得）。
- 部分解読（Partial break）
  - 平文の一部ビットや属性など部分情報を統計的優位で推定できる。
- 一方向性（OW, One-wayness）
  - 暗号文から元の平文を当てることが困難（当てっこゲームで優位性が無い）。
- Semantic Security（意味的安全性）
  - 暗号文から平文に関するいかなる計算可能情報も得られない。PKE では SS-CPA と IND-CPA は同値。
- 識別不可能性（IND-X）
  - 2 つの候補平文の暗号文を識別できない性質。X に CPA/CCA1/CCA2 を入れて強度を区別（IND-CCA2 が最強）。
- 頑強性（Robustness）
  - 「不正な入力や鍵取り違え時に安全に失敗する」性質。特に KEM では、異なる公開鍵で生成したカプセルが他の秘密鍵で同じ共有鍵を導かない（衝突しない）ことを指す定義が用いられる。

### 攻撃モデルと解読モデルの関係性
- モデルの包含関係（代表例）
  - \( \textbf{IND-CCA2} \Rightarrow \textbf{IND-CCA1} \Rightarrow \textbf{IND-CPA} \Rightarrow \textbf{OW-CPA} \)。逆は一般に成り立たない。
  - Semantic Security（SS-CPA）と IND-CPA は同値。IND-CCA2 は非改ざん性（NM-CCA2）も満たす。
- 「全面的/完全/部分」解読は、攻撃者が達成した被害水準の分類であり、IND や OW は達成困難性を形式化した理論的定義。実務では IND-CCA2 を満たす設計により、部分解読や改ざん可能性を含む広範な攻撃を防ぐ。

#### 関係性サマリ（マトリクス）
前提: 各列はそれぞれ「IND-CPA / IND-CCA1 / IND-CCA2 を満たす公開鍵暗号（PKE/KEM）」を意味します。セルは、その前提の下で達成される代表的性質や防げる解読目標を示します。

| 解読モデル/性質                      | CPA（IND-CPA）      | CCA1（IND-CCA1）    | CCA2（IND-CCA2）    |
| ------------------------------------ | ------------------- | ------------------- | ------------------- |
| 全面的解読（秘密鍵回復）を防ぐ       | ○                   | ○                   | ○                   |
| 完全解読（任意復号）を防ぐ           | ○                   | ○                   | ○                   |
| 部分解読（統計的な情報漏えい）を防ぐ | ○                   | ○                   | ○                   |
| 一方向性（OW）                       | ○                   | ○                   | ○                   |
| 意味的安全性（SS）                   | ○（SS-CPA と同値）  | ○                   | ○                   |
| 識別不可能性（IND）                  | ○                   | ○                   | ○                   |
| 非改ざん性（NM）                     | ×（一般に保証せず） | ×（一般に保証せず） | ○（NM-CCA2 と同等） |
| 頑強性（Robustness; KEM）            | △（追加条件が必要） | △（追加条件が必要） | △（追加条件が必要） |

凡例: ○ = 定義上保証/十分に防ぐ、△ = 条件付き/追加仮定が必要、× = 一般には保証しない。

注記:
- SS と IND は同一攻撃モデル下で同値（例: SS-CPA ≡ IND-CPA）。
- 非改ざん性（NM）は CCA2 において IND と同等（NM-CCA2 ≡ IND-CCA2）が知られるが、CPA/CCA1 では一般に同値ではない。
- 頑強性（Robustness; 主に KEM 文脈）は IND とは独立の性質で、鍵取り違えや多受信者設定での衝突防止など、追加の定義・検証が必要。

#### 解読モデル × 攻撃モデル（表記と強度）
同一攻撃モデル（同一列）内での相対強度（弱 < 中 < 強 < 最強）を示します。IND と SS は同一モデル下で同値として併記しています。

| 解読モデル                          | 受動（CPA）            | 能動（CCA1）   | 能動（CCA2）               |
| ----------------------------------- | ---------------------- | -------------- | -------------------------- |
| OW（一方向性）                      | OW-CPA（弱）           | OW-CCA1（弱）  | OW-CCA2（弱）              |
| IND/SS（識別不可能性/意味的安全性） | IND-CPA ≡ SS-CPA（中） | IND-CCA1（中） | IND-CCA2（最強）           |
| NM（非改ざん性）                    | NM-CPA（強）           | NM-CCA1（強）  | NM-CCA2 ≡ IND-CCA2（最強） |

注記:
- 列内の代表的序列: OW-CPA < IND-CPA（≡ SS-CPA） < NM-CPA、OW-CCA1 < IND-CCA1 < NM-CCA1、OW-CCA2 < IND-CCA2（≡ NM-CCA2）。
- 「最強」は当該列（攻撃者能力が同一）における最大強度を表します。列を跨いだ単純比較は前提が異なるため推奨しません。

### 攻撃の種類（実例）
- 公開鍵のすり替え（Key-substitution / 中間者攻撃）
  - 攻撃者が公開鍵配布経路を乗っ取り、正規の公開鍵を攻撃者の鍵に差し替えると、暗号化されたデータは攻撃者が復号可能になる。
  - 対策: 公開鍵の認証（証明書・PKI、署名付きディレクトリ、鍵指紋の確認、TOFU + ピンニング）、KEM では鍵確認/相互認証を併用。
- 全数探索攻撃（Brute-force）
  - 鍵空間・離散対数・素因数分解の困難性に基づく強度を超える計算資源での探索。RSA は 2048/3072 bit 以上、ECC は 256 bit 曲線（例: P-256, Curve25519）以上を用いる。
  - メッセージ空間が小さい場合の辞書攻撃に注意。RSA-OAEP など十分な乱数パディングや KEM+AEAD で回避。

### 実務の要点（ベストプラクティス）
- 直接大容量データを PKE で暗号化しない。KEM+AEAD（ハイブリッド暗号）を用いる。
- CCA2 安全な方式（RSA-OAEP、HPKE など）を選択。乱数・検証に失敗した場合は一定時間で安全に失敗する実装を用いる。
- 鍵長・曲線選定: RSA ≥ 2048 bit（長期では 3072+ 推奨）、ECC は P-256/Curve25519 以上。
- 公開鍵配布の真正性を確保（証明書、署名、ピンニング）。鍵管理/KMS を活用。
- 実装は定数時間化・入力検証・失敗時の情報漏えい最小化（サイドチャネル対策）。

### 代表的なアルゴリズム
- RSA（暗号化は RSA-OAEP、署名は RSA-PSS）
- 楕円曲線ベースの KEM/ECDH（X25519 + HKDF など）
- HPKE（Hybrid Public Key Encryption; KEM+AEAD の標準化フレームワーク）

### サンプルコード
- RSA-OAEP 実装例: `src/asymmetric/rsa_oaep.ts`

### セキュリティ上の注意
- OAEP は少なくとも SHA-256 を使用。RSA で平文サイズには制限があるため、必ずハイブリッド化する。
- 復号失敗の詳細な理由を外部へ漏らさない（エラーメッセージは慎重に）。
- 乱数生成は暗号学的安全な PRNG を使用。

### 参考資料
- RFC 8017（PKCS #1 v2.2: RSA-OAEP/RSA-PSS）
- RFC 9180（HPKE）
- NIST SP 800-56A/B（鍵合意と RSA 鍵確立）
- Katz & Lindell, Introduction to Modern Cryptography
- Boneh & Shoup, A Graduate Course in Applied Cryptography